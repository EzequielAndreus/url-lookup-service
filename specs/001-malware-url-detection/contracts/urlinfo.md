# API Contract: URL Info Endpoint

**Version**: 1.0.0  
**Feature**: 001-malware-url-detection  
**Date**: 2025-12-30  
**Status**: Design

## Endpoint Overview

This document specifies the REST API contract for URL malware detection. The endpoint accepts a URL and returns whether it is associated with known malware.

---

## Endpoint: Check URL for Malware

### Request

**Method**: `GET`

**Path**: `/urlinfo/1/{hostname_and_port}/{original_path_and_query_string}`

**Path Parameters**:
- `hostname_and_port` (string, required): Domain and optional port from the URL
  - Examples: `example.com`, `example.com:8080`, `sub.domain.co.uk`
  - Must be non-empty
  
- `original_path_and_query_string` (string, optional): Path, query string, and fragment from the URL
  - Examples: `path/to/page`, `path?query=value&other=123`, `path#section`
  - May be empty (for root path)
  - URL-encoded if necessary

**Query Parameters**: None

**Request Headers**:
- `X-Request-ID` (string, optional): Unique identifier for this request (for audit tracing)
  - If not provided, server generates one
  - Echoed in response headers and logs

**Request Body**: None

**Examples**:

```
# Simple domain
GET /urlinfo/1/example.com/

# Domain with port
GET /urlinfo/1/example.com:8080/path

# Domain with path and query
GET /urlinfo/1/example.com/path/to/page?category=news&sort=date

# Complex URL with fragment
GET /urlinfo/1/sub.domain.co.uk/deep/path?param1=value1#section

# Root path (implicit)
GET /urlinfo/1/example.com/
```

---

### Response

**Status Code**: 200 OK (successful lookup, regardless of result)

**Response Headers**:
- `Content-Type: application/json`
- `X-Request-ID`: Echo of request ID (or generated)
- `X-Cached`: `true` if response from cache, `false` if queried databases

**Response Body** (JSON):

```json
{
  "url": "https://example.com/path?query=value",
  "is_malicious": false,
  "timestamp": "2025-12-30T12:34:56.789Z",
  "cached": false
}
```

**Response Body Fields**:
- `url` (string): Full URL in normalized form
  - Includes scheme (inferred as https if not provided)
  - Domain normalized to lowercase
  - Path and query preserved from request
  
- `is_malicious` (boolean): True if URL found in ANY malware database, false if not found
  - Represents definitive result based on database contents
  - Not a heuristic or confidence score
  
- `timestamp` (string, ISO 8601): Server response timestamp in UTC
  - Format: `YYYY-MM-DDTHH:MM:SS.sssZ`
  - Useful for correlating with audit logs
  
- `cached` (boolean): Whether response came from cache or live database query
  - True: Response from in-memory cache (faster)
  - False: Response from database query (authoritative)

**Example Responses**:

```json
{
  "url": "https://example.com/",
  "is_malicious": false,
  "timestamp": "2025-12-30T12:34:56.789Z",
  "cached": false
}
```

```json
{
  "url": "https://malware.example.com/payload",
  "is_malicious": true,
  "timestamp": "2025-12-30T12:35:01.234Z",
  "cached": true
}
```

---

## Error Responses

### 400 Bad Request

**When**: Request URL format is invalid or validation fails

**Status Code**: 400

**Response Body**:

```json
{
  "detail": "URL validation failed: missing scheme (http/https)",
  "type": "validation_error",
  "request_id": "req-12345-abcde"
}
```

**Possible Detail Messages**:
- `"URL is empty or null"`
- `"URL exceeds maximum length (2048 characters)"`
- `"URL missing scheme (http/https)"`
- `"URL missing domain"`
- `"URL contains invalid characters"`
- `"Hostname is empty"`

**When to Return**: 
- Empty or null URL
- URL exceeds 2048 characters
- No scheme provided (http/https)
- No domain provided
- Malformed URL that cannot be parsed

---

### 503 Service Unavailable

**When**: All malware databases are temporarily unavailable or unreachable

**Status Code**: 503

**Response Body**:

```json
{
  "detail": "Malware database unavailable; unable to complete lookup",
  "type": "database_error",
  "request_id": "req-12345-abcde"
}
```

**Possible Detail Messages**:
- `"All malware databases are currently unavailable"`
- `"Database connection timeout after 5s"`
- `"Database service returned error"`

**When to Return**:
- No malware databases configured or enabled
- All database loaders timeout (>5 seconds)
- All database loaders return errors
- Database connection pool exhausted

**Retry Guidance**: Client should retry after 5-10 seconds delay

---

### 500 Internal Server Error

**When**: Unexpected server-side error during request processing

**Status Code**: 500

**Response Body**:

```json
{
  "detail": "Internal server error processing request",
  "type": "server_error",
  "request_id": "req-12345-abcde"
}
```

**When to Return**:
- Unexpected exception during URL validation
- Unexpected exception during response formatting
- Server configuration error

**Retry Guidance**: Client should retry; if persistent, contact support with request_id

---

## Response Headers

All responses include these headers:

- `X-Request-ID` (string): Unique identifier for this request
  - Used for audit logging and correlation
  - Client can provide via `X-Request-ID` header; server echoes it
  - If not provided, server generates UUID

- `X-Cached` (string, not in error responses): `true` or `false`
  - Indicates whether response came from cache
  - Useful for understanding latency characteristics

- `X-Response-Time` (string, optional): Time in milliseconds to process request
  - Helps debug performance issues
  - Example: `X-Response-Time: 42`

---

## Request/Response Examples

### Example 1: Safe URL (Not Cached)

**Request**:
```
GET /urlinfo/1/google.com/search?q=python HTTP/1.1
Host: localhost:8000
X-Request-ID: req-20251230-abc123
```

**Response**:
```
HTTP/1.1 200 OK
Content-Type: application/json
X-Request-ID: req-20251230-abc123
X-Cached: false
X-Response-Time: 125

{
  "url": "https://google.com/search?q=python",
  "is_malicious": false,
  "timestamp": "2025-12-30T12:34:56.789Z",
  "cached": false
}
```

---

### Example 2: Malicious URL (Cached)

**Request**:
```
GET /urlinfo/1/malware.example.com/payload HTTP/1.1
Host: localhost:8000
```

**Response**:
```
HTTP/1.1 200 OK
Content-Type: application/json
X-Request-ID: req-20251230-xyz789
X-Cached: true
X-Response-Time: 3

{
  "url": "https://malware.example.com/payload",
  "is_malicious": true,
  "timestamp": "2025-12-30T12:35:01.234Z",
  "cached": true
}
```

---

### Example 3: Invalid URL

**Request**:
```
GET /urlinfo/1// HTTP/1.1
Host: localhost:8000
X-Request-ID: req-20251230-def456
```

**Response**:
```
HTTP/1.1 400 Bad Request
Content-Type: application/json
X-Request-ID: req-20251230-def456

{
  "detail": "Hostname is empty or invalid",
  "type": "validation_error",
  "request_id": "req-20251230-def456"
}
```

---

### Example 4: Database Unavailable

**Request**:
```
GET /urlinfo/1/example.com/ HTTP/1.1
Host: localhost:8000
```

**Response**:
```
HTTP/1.1 503 Service Unavailable
Content-Type: application/json
X-Request-ID: req-20251230-ghi789

{
  "detail": "Malware database unavailable; unable to complete lookup",
  "type": "database_error",
  "request_id": "req-20251230-ghi789"
}
```

---

## Client Integration Examples

### Python

```python
import httpx

async with httpx.AsyncClient() as client:
    response = await client.get(
        "http://localhost:8000/urlinfo/1/example.com/path?query=value"
    )
    
    if response.status_code == 200:
        data = response.json()
        if data["is_malicious"]:
            print(f"ALERT: {data['url']} is malicious!")
        else:
            print(f"OK: {data['url']} is safe")
    elif response.status_code == 400:
        error = response.json()
        print(f"Invalid URL: {error['detail']}")
    elif response.status_code == 503:
        print("Database unavailable; try again later")
```

### JavaScript

```javascript
async function checkURL(url) {
    try {
        const response = await fetch(`/urlinfo/1/${encodeURIComponent(url)}`);
        
        if (response.ok) {
            const data = await response.json();
            return data.is_malicious ? "MALICIOUS" : "SAFE";
        } else if (response.status === 400) {
            const error = await response.json();
            console.error(`Validation error: ${error.detail}`);
        } else if (response.status === 503) {
            console.error("Database temporarily unavailable");
        }
    } catch (error) {
        console.error(`Network error: ${error.message}`);
    }
}

// Usage
console.log(await checkURL("https://example.com"));
```

---

## Contract Validation Rules

- ✅ Endpoint path format: `/urlinfo/1/{hostname_and_port}/{original_path_and_query_string}`
- ✅ Method: GET (read-only, no side effects)
- ✅ Response always includes: `url`, `is_malicious`, `timestamp`
- ✅ Response always JSON (application/json)
- ✅ Success response: 200 regardless of malicious status
- ✅ Validation error: 400 with clear detail message
- ✅ Database error: 503 with retry guidance
- ✅ All responses include X-Request-ID for tracing
- ✅ Async design: No blocking I/O in request path
- ✅ Edge cases: Handles query strings, fragments, ports, internationalized domains

---

## Changelog

### v1.0.0 (2025-12-30)
- Initial contract specification
- GET /urlinfo/1/{hostname_and_port}/{path} endpoint
- Simple boolean response (is_malicious)
- Three error response types (400, 503, 500)
- Request tracing via X-Request-ID header
