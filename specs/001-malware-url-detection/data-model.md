# Data Model: Malware URL Detection API

**Date**: 2025-12-30  
**Feature**: 001-malware-url-detection  
**Purpose**: Define entities, relationships, and validation rules for the API

## Core Entities

### 1. URLCheckRequest

**Purpose**: Represents an incoming request to check a URL for malware associations

**Attributes**:
- `url` (string, required): The full URL to check (including scheme and domain)
  - Validation: Must be between 1-2048 characters, valid URL format (scheme + domain required)
  - Examples: `https://example.com`, `http://example.com/path?query=1`, `https://sub.domain.co.uk/deep/path`
  
- `request_id` (string, optional): Unique identifier for this request (for audit logging and tracing)
  - Auto-generated if not provided
  - Format: UUID or timestamp-based identifier
  - Used in all logs and error responses for correlation

**Validation Rules**:
- URL must not be empty or null
- URL must contain both scheme (http/https) and domain
- URL length must not exceed 2048 characters
- URL must be properly formatted (no control characters, properly encoded)
- If request_id provided, must be unique

**State Transitions**: 
- Input → Validated → Queried → Responded
- Invalid → Error Response (400)
- Query Failure → Error Response (503)

---

### 2. URLCheckResponse

**Purpose**: Represents the API response to a URL check request

**Attributes**:
- `url` (string, required): Echo of the checked URL (normalized form)
  - Consistency: Should match normalized version stored in cache and database
  
- `is_malicious` (boolean, required): True if URL is in ANY malware database, false otherwise
  - Truth value: Aggregation across all database loaders (OR logic: any match = malicious)
  - Certainty: 100% match with database contents (no heuristics, pure database lookup)
  
- `timestamp` (datetime, required): Server response timestamp in ISO 8601 format
  - Format: `2025-12-30T12:34:56.789Z`
  - Purpose: Client can correlate with logs for audit
  
- `cached` (boolean, optional): Indicates if response came from cache
  - True if result was cached from previous lookup
  - False if result queried from databases
  - Helps developers understand latency characteristics

**Example Response**:
```json
{
  "url": "https://example.com/path",
  "is_malicious": false,
  "timestamp": "2025-12-30T12:34:56.789Z",
  "cached": true
}
```

**Validation Rules**:
- URL must be non-empty and normalized
- is_malicious must be boolean
- timestamp must be valid ISO 8601 datetime

---

### 3. ThreatInfo (Internal Entity)

**Purpose**: Represents threat information returned by individual database loaders

**Attributes**:
- `url` (string): The URL that matched in the database
- `threat_level` (enum): Severity level of the threat
  - Values: `MALWARE`, `PHISHING`, `PUP` (Potentially Unwanted Program)
  - Used for logging; collapsed to boolean in response
  
- `threat_source` (string): Which database/loader found this threat
  - Examples: `file_loader`, `google_safe_browsing`, `phishtank_api`
  - Used for debugging and auditing which loader detected the threat
  
- `updated_at` (datetime): When this threat was added to the database
  - Used to validate cache freshness
  - Can alert if database is stale

**Validation Rules**:
- url must be non-empty
- threat_level must be one of the defined enum values
- threat_source must match a configured loader name
- updated_at must be valid datetime

**Note**: This entity is internal to services; not exposed in API response

---

### 4. URLCache (Internal Entity)

**Purpose**: Represents cached lookup results

**Attributes**:
- `url` (string): Normalized URL (cache key)
- `is_malicious` (boolean): Cached result
- `timestamp` (datetime): When result was cached
- `ttl_seconds` (int): Time-to-live for this cache entry
  - Default: 3600 (1 hour)
  - Configurable per deployment
  
- `source` (string): Which loaders were queried to produce this cached result
  - Helps understand if cache is stale (if new loaders added)

**Validation Rules**:
- url must be normalized and valid
- is_malicious must be boolean
- ttl_seconds must be positive integer
- timestamp must be valid datetime

**State Transitions**:
- New entry → Active (within TTL) → Expired → Evicted from cache
- Size limit: Oldest entries evicted when cache reaches max size (LRU)

---

### 5. MalwareDatabase (Abstract Entity)

**Purpose**: Represents a malware URL database source

**Attributes**:
- `name` (string, required): Unique identifier for this database source
  - Examples: `local_csv`, `google_safe_browsing`, `phishtank`
  
- `type` (enum, required): Type of database source
  - Values: `FILE`, `HTTP_ENDPOINT`, `SQL_DATABASE` (future)
  - Determines which loader implementation handles this source
  
- `enabled` (boolean, required): Whether to query this database
  - Allows disabling sources without code changes
  
- `config` (dict, required): Database-specific configuration
  - FILE: `{ "path": "/path/to/malware_urls.csv" }`
  - HTTP_ENDPOINT: `{ "url": "https://api.example.com/malware", "timeout": 5.0 }`
  - Loader reads this config to initialize connection/file access
  
- `last_updated` (datetime): Timestamp of last data refresh
  - Used to detect stale databases
  - Logged for audit purposes

**Validation Rules**:
- name must be non-empty and unique across all configured databases
- type must match defined enum
- enabled must be boolean
- config must contain all required fields for the given type
- last_updated must be valid datetime if provided

**Note**: This entity is managed through configuration (pyproject.toml or .env), not API

---

## Entity Relationships

```
URLCheckRequest
  ↓ (validates)
URLCheckResponse (aggregates results from)
  ↓
[FileLoader] → ThreatInfo
[HTTPLoader] → ThreatInfo
[SQLLoader]  → ThreatInfo (future)
  ↓
MalwareDatabase (config drives loaders)

URLCache (stores)
  ↓
URLCheckResponse (reuses)
```

---

## Validation Rules Summary

| Entity | Field | Rule |
|--------|-------|------|
| URLCheckRequest | url | Non-empty, valid URL, scheme+domain required, ≤2048 chars |
| URLCheckRequest | request_id | Optional, unique if provided |
| URLCheckResponse | url | Non-empty, normalized, matches request |
| URLCheckResponse | is_malicious | Boolean (no null/undefined) |
| URLCheckResponse | timestamp | Valid ISO 8601 datetime |
| URLCheckResponse | cached | Boolean |
| ThreatInfo | threat_level | One of: MALWARE, PHISHING, PUP |
| ThreatInfo | threat_source | Must match configured loader name |
| URLCache | ttl_seconds | Positive integer |
| MalwareDatabase | type | One of: FILE, HTTP_ENDPOINT, SQL_DATABASE |
| MalwareDatabase | config | Must contain all required fields for type |

---

## State Management

### URL Lookup Lifecycle

```
[Request Received]
    ↓
[Validate Request]
    ├─ Valid → Continue
    └─ Invalid → Return 400 Error
    ↓
[Check Cache]
    ├─ Hit (not expired) → Return cached response
    └─ Miss or expired → Query databases
    ↓
[Query Loaders in Parallel]
    ├─ Success (any loader) → Continue
    ├─ Timeout (loader) → Log warning, skip loader
    └─ All fail → Return 503 Error
    ↓
[Aggregate Results]
    ├─ Any loader found threat → is_malicious = true
    └─ No loaders found threat → is_malicious = false
    ↓
[Cache Result]
    └─ Store in URLCache with TTL
    ↓
[Return Response]
    └─ URLCheckResponse with timestamp
```

---

## Performance Considerations

- **URL Normalization**: Performed once per request (before cache/database lookup)
- **Cache Lookup**: O(1) hash table lookup; minimal latency
- **Parallel Database Queries**: All loaders queried concurrently via asyncio.gather()
- **Memory**: Cache bounded to configurable size (default 10,000 entries)
- **Timeout**: Each loader has independent timeout (default 5s); doesn't block others

---

## Future Extensions

The entity model supports these future enhancements without breaking changes:

1. **SQL Database Support**: Add SQLLoader, configure MalwareDatabase with SQL type
2. **Threat Scoring**: Extend URLCheckResponse with threat_score (0-100)
3. **Database Freshness Warnings**: Track and report stale database sources
4. **Request Audit Trail**: Persist URLCheckRequest + response to audit database
5. **Custom Threat Categories**: Extend ThreatInfo with domain-specific threat types
