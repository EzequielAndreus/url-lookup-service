# Quickstart: Malware URL Detection API Development

**Date**: 2025-12-30  
**Feature**: 001-malware-url-detection  
**Target**: Local development on Linux/MacOS

---

## Setup (5 minutes)

### Prerequisites

- Python 3.11+ installed
- pip or conda package manager
- Git (for version control)

### 1. Clone and Navigate

```bash
cd /path/to/url-lookup-service
git checkout 001-malware-url-detection
```

### 2. Create Virtual Environment

```bash
# Option A: venv
python3.11 -m venv venv
source venv/bin/activate  # MacOS/Linux

# Option B: conda
conda create -n urlls python=3.11
conda activate urlls
```

### 3. Install Dependencies

```bash
pip install -e .
# Installs: FastAPI, uvicorn, pydantic, httpx, pytest, pytest-asyncio, cachetools
```

### 4. Create Test Data

```bash
# Create sample malware database
mkdir -p data/malware_lists
cat > data/malware_lists/sample_malware.csv << 'EOF'
malware.example.com
phishing.test.org
badsite.net/malware
EOF

# Note: Paths configured in config.py or environment variables
```

---

## Run the API (1 minute)

### Start Server

```bash
# Development mode (auto-reload)
uvicorn src.main:app --reload --host 0.0.0.0 --port 8000

# Production mode (no reload)
uvicorn src.main:app --host 0.0.0.0 --port 8000 --workers 4
```

### Verify Server

```bash
# In another terminal
curl http://localhost:8000/docs
# Opens interactive API docs (Swagger UI)
```

---

## Test the API (2 minutes)

### Safe URL

```bash
curl "http://localhost:8000/urlinfo/1/google.com/"
```

**Response**:
```json
{
  "url": "https://google.com/",
  "is_malicious": false,
  "timestamp": "2025-12-30T12:34:56.789Z",
  "cached": false
}
```

### Malicious URL (from sample data)

```bash
curl "http://localhost:8000/urlinfo/1/malware.example.com/"
```

**Response**:
```json
{
  "url": "https://malware.example.com/",
  "is_malicious": true,
  "timestamp": "2025-12-30T12:34:57.123Z",
  "cached": false
}
```

### Invalid URL (validation error)

```bash
curl "http://localhost:8000/urlinfo/1//"
```

**Response** (400):
```json
{
  "detail": "Hostname is empty or invalid",
  "type": "validation_error",
  "request_id": "req-12345-abcde"
}
```

### With Query Parameters

```bash
curl "http://localhost:8000/urlinfo/1/example.com/search?q=test&category=news"
```

**Response**:
```json
{
  "url": "https://example.com/search?q=test&category=news",
  "is_malicious": false,
  "timestamp": "2025-12-30T12:34:58.456Z",
  "cached": false
}
```

### With Custom Request ID

```bash
curl -H "X-Request-ID: my-trace-id-123" \
  "http://localhost:8000/urlinfo/1/example.com/"
```

The request ID appears in response headers and all logs for tracing.

---

## Run Tests (3 minutes)

### Run All Tests

```bash
# All tests (unit, integration, contract)
pytest tests/ -v

# With coverage report
pytest tests/ --cov=src --cov-report=html
# Opens htmlcov/index.html for coverage details
```

### Run Specific Test Suites

```bash
# Contract tests (API behavior)
pytest tests/contract/ -v

# Integration tests (end-to-end workflows)
pytest tests/integration/ -v

# Unit tests (individual functions)
pytest tests/unit/ -v

# Performance tests
pytest tests/ -k performance -v
```

### Run with Async Support

```bash
# Required for async tests
pytest tests/ -v --asyncio-mode=auto

# Or configure in pyproject.toml:
# [tool.pytest.ini_options]
# asyncio_mode = "auto"
```

### Test Examples

```bash
# Run specific test file
pytest tests/unit/test_url_validator.py -v

# Run specific test function
pytest tests/unit/test_url_validator.py::test_empty_url_rejected -v

# Run with output capture (see print statements)
pytest tests/ -v -s

# Run tests matching pattern
pytest tests/ -k "validation" -v
```

---

## Development Workflow

### 1. Write Test First

```bash
# tests/unit/test_url_validator.py
def test_url_with_query_params():
    """Edge case: URL contains query parameters"""
    url = "https://example.com/search?q=test&sort=date"
    normalized = URLValidator.validate_and_normalize(url)
    assert "?q=test&sort=date" in normalized  # Query preserved
    assert normalized.startswith("https://")  # Normalized scheme
```

### 2. Run Test (Expect Failure)

```bash
pytest tests/unit/test_url_validator.py::test_url_with_query_params -v
# FAILED - NotImplementedError or AssertionError expected
```

### 3. Implement Code

```python
# src/services/url_validator.py
class URLValidator:
    @staticmethod
    def validate_and_normalize(url: str) -> str:
        # Parse URL
        parsed = urlparse(url)
        
        # Normalize and preserve query params
        normalized = urlunparse((
            parsed.scheme or "https",  # Default to https
            parsed.netloc.lower(),      # Lowercase domain
            parsed.path or "/",         # Default root path
            parsed.params,
            parsed.query,               # PRESERVE query string
            parsed.fragment
        ))
        
        return normalized
```

### 4. Run Test (Expect Pass)

```bash
pytest tests/unit/test_url_validator.py::test_url_with_query_params -v
# PASSED
```

### 5. Run Related Tests

```bash
# Verify no regressions in related tests
pytest tests/unit/test_url_validator.py -v
pytest tests/integration/test_malware_detection.py -v
```

### 6. Commit

```bash
git add src/services/url_validator.py tests/unit/test_url_validator.py
git commit -m "feat: preserve query params in URL normalization (handles edge case)"
```

---

## Configuration

### Environment Variables

```bash
# .env or export in shell

# Database configuration
MALWARE_DB_FILES=data/malware_lists/sample_malware.csv
MALWARE_DB_HTTP_URLS=https://api.example.com/malware

# Cache settings
CACHE_ENABLED=true
CACHE_TTL_SECONDS=3600
CACHE_MAX_ENTRIES=10000

# API settings
API_HOST=0.0.0.0
API_PORT=8000
API_LOG_LEVEL=INFO

# Performance
DB_QUERY_TIMEOUT_SECONDS=5
CONNECTION_POOL_SIZE=100
```

### Config File (config.py)

```python
# src/config.py
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # Database
    malware_db_files: list[str] = [
        "data/malware_lists/sample_malware.csv"
    ]
    malware_db_http_urls: list[str] = []
    
    # Cache
    cache_enabled: bool = True
    cache_ttl_seconds: int = 3600
    cache_max_entries: int = 10000
    
    # API
    api_host: str = "0.0.0.0"
    api_port: int = 8000
    api_log_level: str = "INFO"
    
    # Performance
    db_query_timeout_seconds: float = 5.0
    connection_pool_size: int = 100
    
    class Config:
        env_file = ".env"
        case_sensitive = False

settings = Settings()
```

---

## Common Tasks

### Add a New Malware Database (File)

1. **Create CSV file**:
   ```bash
   cat data/malware_lists/another_list.csv << 'EOF'
   badurl1.com
   badurl2.net
   phishing.org
   EOF
   ```

2. **Update config**:
   ```python
   # src/config.py
   malware_db_files: list[str] = [
       "data/malware_lists/sample_malware.csv",
       "data/malware_lists/another_list.csv",  # NEW
   ]
   ```

3. **Verify** (loaders initialized automatically):
   ```bash
   curl http://localhost:8000/urlinfo/1/badurl1.com/
   # Should return is_malicious: true
   ```

### Add a New Malware Database (HTTP Endpoint)

1. **Update config**:
   ```python
   # src/config.py
   malware_db_http_urls: list[str] = [
       "https://api.example.com/malware/urls"  # NEW
   ]
   ```

2. **Restart server** (loads new endpoint)

3. **Verify**:
   ```bash
   curl -v http://localhost:8000/urlinfo/1/example.com/
   # Logs show HTTP loader querying external API
   ```

### Debug with Logs

```bash
# Set log level to DEBUG
export API_LOG_LEVEL=DEBUG
uvicorn src.main:app --reload

# Now see detailed logs for:
# - URL parsing steps
# - Cache hits/misses
# - Loader query times
# - Individual database results
# - Error handling
```

### Performance Testing

```bash
# Simple load test with Apache Bench
ab -n 1000 -c 100 "http://localhost:8000/urlinfo/1/example.com/"

# Or with wrk (more sophisticated)
wrk -t 4 -c 100 -d 30s "http://localhost:8000/urlinfo/1/example.com/"

# Response: should handle 100+ concurrent without blocking
```

### Clear Cache

```bash
# Restart server (cache is in-memory, lost on restart)
# Or add endpoint to manually clear (future feature)
```

---

## Directory Structure

```
url-lookup-service/
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ pyproject.toml                  # Project metadata and dependencies
‚îú‚îÄ‚îÄ .env                            # Local environment (not in git)
‚îÇ
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ main.py                     # FastAPI app
‚îÇ   ‚îú‚îÄ‚îÄ config.py                   # Configuration management
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ url_check.py            # Pydantic models
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ malware_db.py           # Database models
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ url_validator.py        # URL validation logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ malware_checker.py      # Orchestrator
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ database_loaders/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ base.py             # Abstract loader
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ file_loader.py      # CSV/JSON loader
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ http_loader.py      # HTTP endpoint loader
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ urlinfo.py              # FastAPI router
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ logging.py              # Structured logging
‚îÇ       ‚îî‚îÄ‚îÄ cache.py                # Caching utility
‚îÇ
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ conftest.py                 # pytest configuration
‚îÇ   ‚îú‚îÄ‚îÄ fixtures/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sample_malware_urls.csv # Test data
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sample_malware_urls.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mock_http_server.py     # Mock HTTP endpoint
‚îÇ   ‚îú‚îÄ‚îÄ contract/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_urlinfo_contract.py# API contract tests
‚îÇ   ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_malware_detection.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_database_loaders.py
‚îÇ   ‚îî‚îÄ‚îÄ unit/
‚îÇ       ‚îú‚îÄ‚îÄ test_url_validator.py   # Validation tests
‚îÇ       ‚îú‚îÄ‚îÄ test_malware_checker.py # Logic tests
‚îÇ       ‚îî‚îÄ‚îÄ test_url_normalization.py
‚îÇ
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îî‚îÄ‚îÄ malware_lists/
‚îÇ       ‚îî‚îÄ‚îÄ sample_malware.csv      # Sample malware database
‚îÇ
‚îî‚îÄ‚îÄ specs/
    ‚îî‚îÄ‚îÄ 001-malware-url-detection/  # This feature
        ‚îú‚îÄ‚îÄ spec.md                  # Feature spec
        ‚îú‚îÄ‚îÄ plan.md                  # Implementation plan
        ‚îú‚îÄ‚îÄ research.md              # Technical research
        ‚îú‚îÄ‚îÄ data-model.md            # Entity definitions
        ‚îú‚îÄ‚îÄ quickstart.md            # This file
        ‚îî‚îÄ‚îÄ contracts/
            ‚îî‚îÄ‚îÄ urlinfo.md           # API contract
```

---

## Troubleshooting

### "Address already in use" error

```bash
# Port 8000 already in use
# Option 1: Kill process on port 8000
lsof -i :8000
kill -9 <PID>

# Option 2: Use different port
uvicorn src.main:app --port 8001
```

### "Module not found" error

```bash
# Make sure virtual environment is activated
source venv/bin/activate
# Or pip install -e . again
pip install -e .
```

### Tests fail with "asyncio" errors

```bash
# Ensure pytest-asyncio installed and configured
pip install pytest-asyncio

# In pyproject.toml:
[tool.pytest.ini_options]
asyncio_mode = "auto"
```

### Database not loading

```bash
# Verify file exists and path is correct
ls -la data/malware_lists/

# Check logs for specific error
export API_LOG_LEVEL=DEBUG
# Look for "Loading database" messages
```

---

## Next Steps

1. ‚úÖ Run quickstart setup and verify API works
2. üìù Review [spec.md](spec.md) for detailed requirements
3. üìä Review [data-model.md](data-model.md) for entity structure
4. üîå Review [contracts/urlinfo.md](contracts/urlinfo.md) for API contract
5. üìã Follow [plan.md](plan.md) for implementation structure
6. ‚úçÔ∏è See `tasks.md` for detailed task breakdown by user story
7. üß™ Write tests first per constitution requirement
8. üíª Implement incrementally, one task at a time
9. üîç Use logs for debugging and transparency

---

## Support

- **Questions about spec**: See [spec.md](spec.md)
- **Questions about API**: See [contracts/urlinfo.md](contracts/urlinfo.md)
- **Questions about architecture**: See [plan.md](plan.md) and [research.md](research.md)
- **Questions about entities**: See [data-model.md](data-model.md)
- **Implementation questions**: See tasks.md once generated
