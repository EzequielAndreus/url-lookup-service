"""Pydantic models for malware database configuration and caching."""

from datetime import datetime

from pydantic import BaseModel, ConfigDict, Field


class URLEntry(BaseModel):
    """Single URL entry in malware database."""

    model_config = ConfigDict(
        json_schema_extra={
            "example": {
                "hostname": "malware.example.com",
                "port": 443,
                "path": "/trojan",
                "threat_type": "trojan",
                "threat_level": "high",
            }
        }
    )

    hostname: str = Field(..., description="Domain name")
    port: int = Field(default=80, description="Port number", ge=1, le=65535)
    path: str = Field(default="/", description="URL path")
    threat_type: str | None = Field(default=None, description="Type of threat")
    threat_level: str = Field(default="medium", description="Threat severity")


class MalwareDatabaseConfig(BaseModel):
    """Configuration for a malware database source."""

    model_config = ConfigDict(
        json_schema_extra={
            "example": {
                "name": "local-csv",
                "source_type": "file",
                "source_path": "data/malware_lists/sample_malware.csv",
                "file_format": "csv",
                "timeout_seconds": 2.0,
                "enabled": True,
            }
        }
    )

    name: str = Field(..., description="Unique identifier for this database")
    source_type: str = Field(
        ...,
        description="Type of source: file (CSV/JSON) or http (API endpoint)",
        pattern="^(file|http)$",
    )
    source_path: str = Field(..., description="File path for file-based, URL for http-based")
    file_format: str | None = Field(default="csv", description="For file sources: csv or json")
    http_method: str | None = Field(default="GET", description="For http sources: GET or POST")
    timeout_seconds: float = Field(default=5.0, description="Query timeout", gt=0)
    enabled: bool = Field(default=True, description="Whether to use this database")


class CacheEntry(BaseModel):
    """Single entry in the URL cache."""

    model_config = ConfigDict(
        json_schema_extra={
            "example": {
                "url": "https://example.com:443/",
                "is_malicious": False,
                "threat_level": "safe",
                "cached_at": "2024-12-30T12:00:00Z",
                "ttl_seconds": 3600,
            }
        }
    )

    url: str = Field(..., description="The URL that was checked")
    is_malicious: bool = Field(..., description="Cached result")
    threat_level: str = Field(default="safe", description="Threat severity")
    cached_at: datetime = Field(default_factory=datetime.utcnow, description="When cached")
    ttl_seconds: int = Field(default=3600, description="Cache TTL")


class LoaderStatistics(BaseModel):
    """Statistics for a database loader."""

    model_config = ConfigDict(
        json_schema_extra={
            "example": {
                "name": "local-csv",
                "total_queries": 1000,
                "successful_queries": 995,
                "failed_queries": 5,
                "malicious_urls_found": 42,
                "avg_response_time_ms": 12.5,
                "last_query_time": "2024-12-30T12:00:00Z",
            }
        }
    )

    name: str = Field(..., description="Loader name")
    total_queries: int = Field(default=0, description="Total queries made")
    successful_queries: int = Field(default=0, description="Successful queries")
    failed_queries: int = Field(default=0, description="Failed queries")
    malicious_urls_found: int = Field(default=0, description="Malicious URLs detected")
    avg_response_time_ms: float = Field(default=0.0, description="Average response time")
    last_query_time: datetime | None = Field(default=None, description="Last query timestamp")
